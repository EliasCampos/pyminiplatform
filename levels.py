import operator

import pygame

from configs import config, WINDOW_WIDTH, WINDOW_HEIGHT
from entities import Block, Lava, Coin, Player


class Level:

    def __init__(self, level_map):
        self.player = None
        self.lavas = []
        self.coins = []
        self.blocks = []
        self.level_map = level_map
        self.speed_factor = 1

    def reset(self):
        self.player = None
        self.lavas = []
        self.coins = []
        self.blocks = []

        for i, line in enumerate(self.level_map):
            for j, el in enumerate(line):
                location = pygame.Vector2(j * Block.SIZE, i * Block.SIZE)
                if el in ("+", "v", "|", "="):
                    direction = pygame.Vector2(el == "=", el in ("v", "|"))
                    lava = Lava(location, direction, is_repeatable=el == "v")
                    self.lavas.append(lava)
                elif el == "o":
                    coin = Coin(location)
                    self.coins.append(coin)
                elif el == "@":
                    self.player = Player(location)
                elif el == "#":
                    block = Block(location)
                    self.blocks.append(block)

    @property
    def entities(self):
        return sum((
            self.blocks,
            self.coins,
            self.lavas,
        ), [])

    def update(self, time):
        self._handle_keypress(time)
        self.player.update(time, level=self)

        config.offset_x = self.player.rect.x - WINDOW_WIDTH // 2
        config.offset_y = self.player.rect.y - WINDOW_HEIGHT // 2

        for entity in self.entities:
            entity.update(time, level=self)

        self.coins = list(filter(operator.attrgetter("is_free"), self.coins))
        if not self.coins:
            self.player.set_won()

    def redraw(self, screen):
        self.player.render(screen)
        for entity in self.entities:
            entity.render(screen)

    @property
    def is_running(self):
        return not (self.player.is_dead or self.player.is_winner)

    @property
    def is_complete(self):
        return self.player.is_winner

    def _handle_keypress(self, time):
        keys = pygame.key.get_pressed()
        if keys[pygame.K_LEFT]:
            self.player.move_left(time)
        if keys[pygame.K_RIGHT]:
            self.player.move_right(time)
        if keys[pygame.K_UP]:
            self.player.jump(time)

    @classmethod
    def get_default_set(cls):
        level_maps = [
            (
                "............................................................................##..",
                ".............................................................................#..",
                ".............................................................................#..",
                ".............................................................................#..",
                ".............................................................................#..",
                ".............................................................................#..",
                "..##..............................................................###........#..",
                "..#................................................##......##....##+##.......#..",
                "..#.................................o.o......##..................#+++#.......#..",
                "..#..............................................................##+##.......#..",
                "..#................................#####..........................#v#........#..",
                "..#..........................................................................#..",
                "..#.......................................o.o................................#..",
                "..#.....................o....................................................#..",
                "..#..@...................................#####.............................o.#..",
                "..#..........####.......o....................................................#..",
                "..#..........#..#................................................#####.......#..",
                "..############..###############...####################.....#######...#########..",
                "..............................#...#..................#.....#....................",
                "..............................#+++#..................#+++++#....................",
                "..............................#+++#..................#+++++#....................",
                "..............................#####..................#######....................",
                "................................................................................",
                "................................................................................",
            ),
            (
                "................................................................................",
                "................................................................................",
                "....###############################.............................................",
                "...##.............................##########################################....",
                "...#.......................................................................##...",
                "...#....o...................................................................#...",
                "...#................................................=.......................#...",
                "...#.o........################...................o..o...........|........o..#...",
                "...#.........................#..............................................#...",
                "...#....o....................##########.....###################....##########...",
                "...#..................................#+++++#.................#....#............",
                "...###############....oo......=o.o.o..#######.###############.#....#............",
                ".....#...............o..o.............#.......#......#........#....#............",
                ".....#....................#############..######.####.#.########....########.....",
                ".....#.............########..............#...........#.#..................#.....",
                ".....#..........####......####...#####################.#..................#.....",
                ".....#........###............###.......................########....########.....",
                ".....#.......##................#########################......#....#............",
                ".....#.......#................................................#....#............",
                ".....###......................................................#....#............",
                ".......#...............o...........................................#............",
                ".......#...............................................o...........#............",
                ".......#########......###.....############.........................##...........",
                ".............#..................#........#####....#######.o.........########....",
                ".............#++++++++++++++++++#............#....#.....#..................#....",
                ".............#++++++++++++++++++#..........###....###...####.o.............#....",
                ".............####################..........#........#......#.....|.........#....",
                "...........................................#++++++++#......####........@...#....",
                "...........................................#++++++++#.........#............#....",
                "...........................................#++++++++#.........##############....",
                "...........................................##########...........................",
                "................................................................................",
            ),
            (
                "......................................#++#........................#######.........############################+#.#",
                "......................................#++#.....................####.....####....##...........................#+#.#",
                "......................................#++##########...........##...........##..##............................#+#.#",
                "......................................##++++++++++##.........##.............##...............................#+#.#",
                ".......................................##########++#.........#....................................o...o...o..#+#.#",
                "................................................##+#.........#.....o...o....................................##+#.#",
                ".................................................#+#.........#................................###############++#.#",
                ".................................................#v#.........#.....#...#........................++++++++++++++##.#",
                "##...........................................................##..|...|...|..##...........######################..#",
                "#.............................................................##+++++++++++##............v.......................#",
                "#..............................................................####+++++####.....................................#",
                "#..............................................#.....#............#######........###.........###.................#",
                "#..............................................#.....#...........................#.#.........#.#.................#",
                "#..............................................#.....#.............................#.........#...................#",
                "#..............................................#....##.............................#........##...................#",
                "#..............................................#.....#.............................##........#...................#",
                "#..............................................#.....#......o..o.....#...#.........#.........#...................#",
                "#..............#######........###...###........##....#...............#...#.........#.........#...................#",
                "#.............##.....##.........#...#..........#.....#.....######....#...#...#########.......#...................#",
                "#....@.......##.......##........#.o.#..........#....##...............#...#####..............##...................#",
                "#............#.........#........#...#..........#.....#...............#.....o.................#...................#",
                "#...###......#.........#........#...#..........#.....#...............#...........######......#...................#",
                "#...#.#......#.........#.......##.o.##.........##....#...............#...........#.#.........#...................#",
                "#+++#.#++++++#.........#++++++##.....##++++++++#.....#++++++++++.....#.....=.....#.#.........#...................#",
                "#+++#.#++++++#.........#+++++##.......##########.....#+++++++##+.....#############.##..o.o..##...................#",
                "#+++#.#++++++#.........#+++++#....o.................##++++++##.+....................##.....##....................#",
                "#+++#.#++++++#.........#+++++#.....................##++++++##..+.....................#######.....................#",
                "#+++#.#++++++#.........#+++++##.......##############++++++##...+.................................................#",
                "#+++#.#++++++#.........#++++++#########++++++++++++++++++##....+.................................................#",
                "#####.########.........###########################################################################################",
            ),
            (
                "..............................................................................................................",
                "..............................................................................................................",
                "..............................................................................................................",
                "..............................................................................................................",
                "..........................................................................................................##..",
                "........................................o..................................................................#..",
                "...........................................................................................................#..",
                "........................................#..................................................................#..",
                "........................................#..................................................................#..",
                "........................................#..................................................................#..",
                "........................................#..................................................................#..",
                ".......................................###.................................................................#..",
                ".......................................#.#.................+++........+++..###.............................#..",
                ".......................................#.#.................+#+........+#+..................................#..",
                ".....................................###.###................#....##....#...................................#..",
                "......................................#...#.................#..oo##oo..#.......###.........................#..",
                "......................................#...#.................#....##....#......#+++#........................#..",
                "......................................#...#.................############.......###.........................#..",
                ".....................................##...##......#...#......#.............................................#..",
                "......................................#...#########...########..............#.#............................#..",
                "......................................#...#...........#....................#+++#...........................#..",
                "......................................#...#...........#.....................###............................#..",
                ".....................................##...##..........#....................................................#..",
                "......................................#...#=.=.=.=....#............###.....................................#..",
                "......................................#...#...........#...........#+++#....................................#..",
                "......................................#...#....=.=...=#.....o......###.......###...........................#..",
                ".....................................##...##..........#.....................#+++#..........................#..",
                "..............................o...o...#...#...........#.....#................##v........###................#..",
                "......................................#...#...........#..............#.................#+++#...............#..",
                ".............................###.###.###.###.....o.o..#++++++++++++++#...................v#................#..",
                ".............................#.###.#.#.###.#..........#++++++++++++++#.....................................#..",
                ".............................#.............#...#######################.....................................#..",
                ".............................##...........##.........................................###...................#..",
                "..###.........................#.....#...............................................#+++#..................#..",
                "..#.#.........................#....###...............................................###...................#..",
                "..#...........................#....###....#######........................#####.............................#..",
                "..#...........................#...........#..............................#...#.............................#..",
                "..#...........................##..........#..............................#.#.#.............................#..",
                "..#.......................................#.......|####|....|####|.....###.###.............................#..",
                "..#................###.............o.o....#..............................#.........###.....................#..",
                "..#...............#####.......##..........#.............................###.......#+++#..........#.........#..",
                "..#......@........o###o.......#....###....#.............................#.#........###..........###........#..",
                "..#................###........#############..#.oo.#....#.oo.#....#.oo..##.##....................###........#..",
                "..#.................#.........#...........#++#....#++++#....#++++#....##...##....................#.........#..",
                "..#############################...........#############################.....################################..",
                "..............................................................................................................",
                "..............................................................................................................",
            ),
            (
                "#.................................................................................................###.#.......",
                "#.....................................................................................................#.......",
                "#.................................................................................................#####.......",
                "#.................................................................................................#...........",
                "#.................................................................................................#.###.......",
                "#.........................o.......................................................................#.#.#.......",
                "#............................................................................................o.o.o###.#.......",
                "#..................###................................................................................#.......",
                "#......+..o..+................................................#####.#####.#####.#####.#####.#####.#####......#",
                "#......#.....#................................................#...#.#...#.#...#.#...#.#...#.#...#.#..........#",
                "#......#=.o..#............#...................................###.#.###.#.###.#.###.#.###.#.###.#.#####......#",
                "#......#.....#..................................................#.#...#.#...#.#...#.#...#.#...#.#.....#......#",
                "#......+..o..+............o..................................####.#####.#####.#####.#####.#####.#######......#",
                "#............................................................................................................#",
                "#.........o..............###..............................##.................................................#",
                "#............................................................................................................#",
                "#............................................................................................................#",
                "#.....................................................##.....................................................#",
                "#..................###.........###...........................................................................#",
                "#............................................................................................................#",
                "#.........................o.....................................................#......#.....................#",
                "#.........................................................##.....##..........................................#",
                "#............###.........###.........###.................................#..................#................#",
                "#............................................................................................................#",
                "#................................................................||..........................................#",
                "#############................................................................................................#",
                "#...........#.o.#########.o.#########.o.##................................................#..................#",
                "#....@......#...#.......#...#.......#...#.................||..................#.....#........................#",
                "#...........#####...o...#####...o...#####....................................................................#",
                "#########.....................................#####.......##.....##.....###..................................#",
                "........#=..................=................=#...#.....................###..................................#",
                "........#######################################...#+++++++++++++++++++++###++++++++++++++++++++++++++++++++++#",
                "..................................................############################################################",
                "..............................................................................................................",
            ),
        ]

        return [cls(level_map) for level_map in level_maps]
